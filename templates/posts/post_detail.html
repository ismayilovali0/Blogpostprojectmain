{% load static %}
<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ post.title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="bg-gray-50">
    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- Back Button -->
        <a href="javascript:history.back()" class="inline-flex items-center text-blue-600 hover:text-blue-800 mb-6">
            <i class="fas fa-arrow-left mr-2"></i> Geri qayıt
        </a>

        <!-- Post Header -->
        <article class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
            <img src="{{ post.thumbnail.url }}" alt="{{ post.title }}" class="w-full h-96 object-cover">
            
            <div class="p-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">{{ post.title }}</h1>
                
                <!-- Post Meta -->
                <div class="flex items-center justify-between mb-6 text-gray-600">
                    <div class="flex items-center space-x-4">
                        <span class="flex items-center">
                            <i class="far fa-user mr-2"></i> 
                            {{ post.author.user.username }}
                        </span>
                        <span class="flex items-center">
                            <i class="far fa-calendar mr-2"></i> 
                            {{ post.timestamp|date:"d M, Y" }}
                        </span>
                        <span class="flex items-center">
                            <i class="far fa-eye mr-2"></i> 
                            {{ post.view_count }} oxunma
                        </span>
                    </div>
                </div>

                <!-- Like, Favourite Buttons -->
                <div class="flex items-center space-x-4 mb-6 pb-6 border-b">
                    {% if user.is_authenticated %}
                        <!-- Like Button -->
                        <button onclick="toggleLike({{ post.pk }})" id="like-btn-{{ post.pk }}"
                                class="like-btn {% if is_liked %}active{% endif %}">
                            <i class="{% if is_liked %}fas{% else %}far{% endif %} fa-heart"></i>
                            <span id="like-count-{{ post.pk }}">{{ like_count }}</span>
                        </button>

                        <!-- Favourite Button -->
                        <button onclick="toggleFavourite({{ post.pk }})" id="fav-btn"
                                class="fav-btn {% if is_favourited %}active{% endif %}">
                            <i class="{% if is_favourited %}fas{% else %}far{% endif %} fa-star"></i>
                            <span id="fav-count">{{ favourite_count }}</span>
                        </button>
                    {% else %}
                        <div class="text-gray-600">
                            <i class="far fa-heart"></i> {{ like_count }} bəyənmə
                            <span class="ml-4"><i class="far fa-star"></i> {{ favourite_count }} favori</span>
                        </div>
                        <a href="{% url 'login' %}" class="text-blue-600 hover:underline ml-4">
                            Giriş edin
                        </a>
                    {% endif %}
                </div>

                <!-- Post Content -->
                <div class="prose max-w-none mb-8 text-gray-800 leading-relaxed text-lg">
                    {{ post.content|safe }}
                </div>

                <!-- Categories -->
                <div class="flex flex-wrap gap-2 mb-8">
                    {% for category in post.categories.all %}
                        <a href="{% url 'postlist' category.slug %}" 
                           class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm hover:bg-blue-200 transition">
                            {{ category.title }}
                        </a>
                    {% endfor %}
                </div>
            </div>
        </article>

        <!-- Comments Section -->
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h2 class="text-2xl font-bold mb-6">
                <i class="far fa-comments mr-2"></i>
                Şərhlər ({{ comments.count }})
            </h2>

            {% if user.is_authenticated %}
                <!-- Add Comment Form -->
                <form method="POST" action="{% url 'add_comment' post.pk %}" class="mb-8">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="block text-gray-700 font-medium mb-2">Şərhinizi yazın:</label>
                        <textarea name="content" rows="4" required
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder="Fikrinizi bizə bildirin..."></textarea>
                    </div>
                    <button type="submit" 
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Şərh əlavə et
                    </button>
                </form>
            {% else %}
                <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-8">
                    <p class="text-gray-700">
                        <i class="fas fa-info-circle mr-2"></i>
                        Şərh yazmaq üçün 
                        <a href="{% url 'login' %}" class="text-blue-600 hover:underline font-medium">
                            giriş edin
                        </a>
                    </p>
                </div>
            {% endif %}

            <!-- Comments List -->
            <div class="space-y-6">
                {% for comment in comments %}
                    <div class="comment-box">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                                    {{ comment.user.username|first|upper }}
                                </div>
                                <span class="font-semibold text-gray-900">{{ comment.user.username }}</span>
                                <span class="text-gray-500 text-sm">{{ comment.created_at|timesince }} əvvəl</span>
                            </div>
                        </div>
                        <p class="text-gray-700 ml-10">{{ comment.content }}</p>
                    </div>
                {% empty %}
                    <div class="text-center py-12">
                        <i class="far fa-comment-dots text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">Hələ heç bir şərh yoxdur.</p>
                        <p class="text-gray-400">İlk şərhi siz yazın!</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- JavaScript for Like/Favourite -->
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        function toggleLike(postId) {
            fetch(`/post/${postId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                const btn = document.getElementById('like-btn');
                const icon = btn.querySelector('i');
                const count = document.getElementById('like-count');
                
                if (data.liked) {
                    btn.classList.add('active');
                    icon.className = 'fas fa-heart';
                } else {
                    btn.classList.remove('active');
                    icon.className = 'far fa-heart';
                }
                count.textContent = data.like_count;
            })
            .catch(error => console.error('Error:', error));
        }

        function toggleFavourite(postId) {
            fetch(`/post/${postId}/favourite/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                const btn = document.getElementById('fav-btn');
                const icon = btn.querySelector('i');
                const count = document.getElementById('fav-count');
                
                if (data.favourited) {
                    btn.classList.add('active');
                    icon.className = 'fas fa-star';
                } else {
                    btn.classList.remove('active');
                    icon.className = 'far fa-star';
                }
                count.textContent = data.favourite_count;
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>